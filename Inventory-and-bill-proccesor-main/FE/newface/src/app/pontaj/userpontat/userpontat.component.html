<div class="wrap">
  <div class="bar">
    <div class="title">
      <a routerLink="/pontaj" class="back">← Înapoi</a>
      <h2>{{ userName || 'Utilizator' }}</h2>
    </div>
    <div class="picker">
      <label>Luna</label>
      <input type="month" [value]="selectedMonth" (change)="onMonthChange($event)">
    </div>
  </div>

  <div class="summary">
    <div class="badge">Perioadă: {{ startISO }} → {{ endISO }}</div>
    <div class="badge">Total ore lună: {{ durataOre(monthTotal) }}</div>
    <div class="badge strong">
      Salariu lună:
      <ng-container *ngIf="monthSalary !== null; else noPay">
        {{ monthSalary | number:'1.2-2' }} lei
      </ng-container>
      <ng-template #noPay>—</ng-template>
    </div>
  </div>

  <div class="state" *ngIf="loading">Se încarcă…</div>
  <div class="state error" *ngIf="error">{{ error }}</div>

  <div class="table" *ngIf="!loading && !error">
    <div class="thead">
      <div>Zi</div>
      <div>Locație (zi)</div>
      <div>Sesiuni (Intrare → Ieșire)</div>
      <div>Total zi</div>
      <div>#Intrări / #Ieșiri</div>
      <div>Acțiuni</div>
    </div>

    <div class="row" *ngFor="let d of days">
      <!-- Zi -->
      <div class="cell date">
        <div class="d1">{{ d.date | date:'dd MMM' }}</div>
        <div class="d2">{{ d.date | date:'EEEE' }}</div>
      </div>

      <!-- Locație (zi) + Concediu/Abs -->
      <div class="cell site-day">
        <ng-container *ngIf="d.day_worksite; else noSite">
          <span class="chip">{{ d.day_worksite }}</span>
        </ng-container>
        <ng-template #noSite><span class="muted">—</span></ng-template>

        <!-- Leave badge, dacă există -->
        <div class="leave-line" *ngIf="d.leave">
          <span
            class="chip leave"
            [title]="(mapLeave[d.leave.reason] || d.leave.reason) + ' · ' + fmtLeaveHours(d.leave.hours) + ' ×' + d.leave.multiplier"
          >
            {{ mapLeave[d.leave.reason] || d.leave.reason }}
            — {{ fmtLeaveHours(d.leave.hours) }} ×{{ d.leave.multiplier }}
          </span>
        </div>
      </div>

      <!-- Sesiuni -->
      <div class="cell sess-col">
        <div class="sess-row" *ngIf="d.sessions.length === 0">
          <span class="muted">—</span>
        </div>

        <div class="sess-row" *ngFor="let s of d.sessions">
          <div class="in">{{ hm(s.in_time) }}</div>
          <div class="arrow">→</div>
          <div class="out">
            <ng-container *ngIf="s.out_time; else openTag">{{ hm(s.out_time) }}</ng-container>
            <ng-template #openTag><span class="open">deschis</span></ng-template>
          </div>
          <div class="dur">{{ durataOre(s.duration_hms) }}</div>

          <!-- Site + buton ștergere sesiune -->
          <div class="site">
            <span class="chip" *ngIf="s.worksite">{{ s.worksite }}</span>
            <button
              class="btn danger"
              *ngIf="s.session_id"
              style="margin-left:8px"
              title="Șterge această sesiune"
              (click)="deleteSingleSession(s)">
              Șterge
            </button>
          </div>
        </div>
      </div>

      <!-- Total / Counts -->
      <div class="cell total">{{ durataOre(d.total_hms) }}</div>
      <div class="cell counts">{{ d.entries }} / {{ d.exits }}</div>

      <!-- Acțiuni -->
      <div class="cell actions">
        <button class="btn" (click)="openEditor(d)">Editează</button>
        <button class="btn danger" (click)="clearDayConfirm(d)">Șterge</button>
      </div>

      <!-- Editor in-line -->
      <div class="editor" *ngIf="editingDate === d.date">
        <div class="editor-bar">
          <div class="modes">
            <button class="tab" [class.active]="mode==='sessions'" (click)="mode='sessions'">Sesiuni</button>
            <button class="tab" [class.active]="mode==='leave'" (click)="mode='leave'">Lipsă zi de lucru</button>
          </div>
          <div class="spacer"></div>
          <button class="btn secondary" (click)="cancelEditor()">Anulează</button>
        </div>

        <!-- MOD: SESSIUNI -->
        <div *ngIf="mode==='sessions'" class="form-grid">
          <p class="full hint">Editează intrarea, ieșirea și șantierul. Poți adăuga/șterge rânduri.</p>

          <div class="sess-edit-row" *ngFor="let s of sessForm; let i = index">
            <div>
              <label>Intrare</label>
              <input type="text" placeholder="07:30" [(ngModel)]="s.in">
            </div>
            <div>
              <label>Ieșire</label>
              <input type="text" placeholder="17:30" [(ngModel)]="s.out">
            </div>
            <div>
              <label>Locație</label>
              <input type="text" placeholder="ex: Bloc F" [(ngModel)]="s.worksite">
            </div>
            <div class="row-actions">
              <button class="btn danger" (click)="removeSessionRow(i)" *ngIf="sessForm.length>1" title="Șterge rândul">−</button>
            </div>
          </div>

          <div class="full">
            <button class="btn secondary" (click)="addSessionRow()">+ Adaugă sesiune</button>
          </div>

          <div class="full actions-right">
            <button class="btn" [disabled]="saving" (click)="saveSessions(d)">Salvează sesiunile</button>
          </div>
        </div>

        <!-- MOD: LIPSA ZI DE LUCRU -->
        <div *ngIf="mode==='leave'" class="form-grid">
          <p class="full hint">
            Marchează ziua ca absență plătită/neplătită (CO, CM sau Alt motiv) și calculează suma de plată pentru această zi.
          </p>

          <!-- Motiv -->
          <label>Motiv lipsă</label>
          <select [(ngModel)]="leaveForm.reason">
            <option value="CO">CONCEDIU ODIHNĂ</option>
            <option value="CM">CONCEDIU MEDICAL</option>
            <option value="ALT">ALT MOTIV</option>
          </select>

          <!-- Ore pontate -->
          <label>Ore pontate (HH.h)</label>
          <input type="number" min="0" step="0.25" [(ngModel)]="leaveForm.hours" placeholder="ex: 8">

          <!-- Tarif orar -->
          <label>Tarif orar (lei)</label>
          <input type="number" min="0" step="0.01" [(ngModel)]="leaveForm.rate" placeholder="ex: 25">

          <!-- Multiplicator -->
          <div class="full row" style="align-items:center; gap:12px;">
            <label class="checkbox">
              <input type="checkbox" [(ngModel)]="leaveForm.multiplierEnabled">
              Aplică multiplicator
            </label>

            <input
              type="number"
              min="0"
              step="0.01"
              [disabled]="!leaveForm.multiplierEnabled"
              [(ngModel)]="leaveForm.multiplier"
              placeholder="ex: 0.75"
              style="max-width:140px"
            >

            <span class="muted">
              (ex: CM plătit 75% ⇒ multiplicator 0.75)
            </span>
          </div>

          <!-- Total calculat -->
          <div class="full total-line">
            <strong>Total de plată (zi):</strong>
            <span class="sum">
              {{ leaveComputedTotal() | number:'1.2-2' }} lei
            </span>
          </div>

          <div class="full actions-right" style="gap:8px; display:flex; justify-content:flex-end;">
            <button class="btn" [disabled]="saving" (click)="saveLeave(d)">
              Salvează lipsa
            </button>
            <button class="btn danger" *ngIf="d.leave" [disabled]="saving" (click)="deleteLeave(d)">
              Șterge lipsa
            </button>
          </div>
        </div>
      </div>
      <!-- /editor -->
    </div>
  </div>
</div>
